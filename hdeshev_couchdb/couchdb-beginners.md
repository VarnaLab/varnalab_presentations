CouchDB за начинаещи<br/>Христо Дешев - @hdeshev
=======
---

Кратка разходка из NoSQL света
==============================
- Key-Value stores
- Document DBs
- BigTable clones
- Graph DBs, etc

---

Къде се вписва CouchDB
======================

- документна база
- MapReduce изгледи
- акцент върху лесна репликация и offline работа

---

NoSQL - "за" и "против"
==========

- Добри решения за **специфични** проблеми.
- Не са панацея

<u>**Ако някой твърди обратното, то той се опитва да ви продаде нещо!**</u>

---

Къде "блести" CouchDB
=====================

- документите са със свободна структура и не се налага да ги дефинираме предварително.
- гъвкави и странни схеми за индексиране на данни: MapReduce изгледите го позволяват.
- протоколът за комуникация е "обикновен" HTTP
- репликацията е номер 1 - git за бази данни.
- солидно, durable, съхранение на данните [1]
    - защита от сривове
    - лесен бекъп

[1] Тъжно е, че изтъкваме такова предимство, но уточнението се налага!

---

База, която "говори" HTTP
=======================
- бързо и лесно се пишат клиентски библиотеки (драйвери) за всякакви езици
- лесно се скриптира: **curl**
- HTTP кеширане: ETag
- Лесна администрация и всевъзможни фокуси с проксита - nginx и други

Лесно програмиране! Няма постоянна връзка или "сесия" към базата. Това ни освобождава от грижата да инициализираме сесия към базата от всяка нишкa.

---

REST API
========

Всяко важно нещо си има URL.

- GET
- POST
- PUT
- DELETE

---

MVCC - версии на документи
==========================

- всеки документ има свойство _id и го адресираме чрез него
- отделно имаме и свойство _rev (версия).
- всяка промяна на документ изисква _id и _rev.
- ако редактираме стари данни (някой е записал по-нова от нашата версия), редакцията пропада.

---

Дизайн документи
================

- Специални документи. 
- id &rarr; *_design/something*
- Kоито могат да съдържат код или друга служебна информация.
- Например MapReduce изгледи

---

MapReduce увод
==============

Трансформация в две стъпки:

- Map: документ &rArr; (ключ, стойност)*
- Reduce: (ключ, стойности) &rArr; стойност

Map трансформацията може да върне повече от една стойност.

Резултатът от Reduce може да се подаде отново на Reduce.

---

Изгледи само с Map трансформация
================================

Удобни за търсене по определено свойство: дата, имейл, и др.

    !js
    function(doc){
      if (doc.type == "Account"){
        emit(doc.email, doc)
      }
    }

http://localhost:5984/myapp/_design/accounts/_view/by_email?key=john@example.com

---

Повече от един резултат
==========================

- Данните в изгледите са сортирани по ключ.

- Ключът може да е произволен JSON обект.

- *[2011, 10]* < *[2011, 10, 17]* - удобно за взимане на данни за цял ден, месец и т.н.

    /blog/_design/docs/_view/by_date?startkey=[2011, 10]&endkey=[2011, 11]

- Много други трикове!

---

Reduce - агрегация и още много
============================

Map функция:

    !js
    function(doc) {
      if(doc.tags.length > 0) {
        for(var i = 0; i < doc.tags.length; i++) {
          emit(doc.tags[i], 1);
        }
      }
    }

Reduce функция:
    
    !js
    function(keys, values, rereduce) {
        return sum(values);
    }

---

MapReduce - демонстрация
==========

---
Репликация
==========

Пространство:

- eднопосочна
- двупосочна

Време:

- еднократна/периодична
- постоянна

---

Репликация - демонстрация
==========

---

Attachments - файлове в базата
==============================

- Лесни за съхранение
- Директно сервирани от CouchDB
    - трябва да ги предпазим от неоторизиран достъп
    - **nginx** + *X-Accell-Redirect* хедър

---

CouchApps - приложения в базата
===============================

- Кодът (JavaScript) се записва като в базата като дизайн документ:
    - show
    - list
    - validate
    - update
- Статичните файлове (html, css, js, jpg и др.) се записват като attachments.
- API за достъп до данните (JQuery-базирано)
- Има инструменти за по-лесна разработка: [CouchApp.org](http://couchapp.org/)
- Елементарен deployment: репликация!

---

Ограничения на CouchDB
=====================

- няма [лесни] ad-hoc заявки
- трудно триене на много данни
    - *DELETE FROM history WHERE fromDate < X* &larr; **невъзможно**
    - внимавайте с нуждата от често триене, защото тя поражда фрагментация и нужда от compact-ване
- изгледите не се обновяват автоматично, а при поискване
    - параметри: stale=ok, stale=update_after
- compact-ване на файла на базата и изгледите.
    - за щастие лесно се автоматизира и не изисква downtime.
    - в някои случаи, исторически данни например, може да се избегне
        - различни бази за различни периоди + триене на старите бази

---

Ресурси
=======

- *CouchDB the Definitive Guide* - цяла книга достъпна безплатно онлайн: [guide.couchdb.org](http://guide.couchdb.org) 
- *Scaling CouchDB* - книжле с трикове за мащабни инсталации.
- IRC: **#couchdb** на freenode.org мрежата. Винаги има добри хора, които да помогнат.

---

Въпроси?
=======

